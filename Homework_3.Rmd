---
title: "Homework 3"
author: "Brent Rappaport"
date: "September 26, 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#clear workspace
#removes variables from memory (upper right pane)
rm(list=ls(all=TRUE)) 

library(knitr)
library(rmarkdown)
library(kableExtra)
library(tidyr)
library(ggplot2)
library(psych)
library(lme4)
library(broom)
library(merTools)
library(foreach)
library(sjPlot)

data_wide <- read.csv("/Users/BrentRappaport/Box Sync/WashU/Classes/Longtudinal Methods/1-descriptives-and-graphs-brappaport/Rappaport_data.csv")

data_wide$sex_01 <- data_wide$sex-1

data_wide$sex_c <- scale(data_wide$sex_01, center=T, scale=F)
data_wide$T1Income_to_Need_c <- scale(data_wide$T1Income_to_Need, center=T, scale=F)

data_long <- data_wide %>% 
  gather(c(-ID,-sex,-sex_01,-sex_c,-T1_ACES_sum,-ethin,-T1Income_to_Need,-T1Income_to_Need_c,-IQ), 
         key = "time", value = "value") %>% 
  separate(time, into = c("variable", "wave")) %>%
  spread(variable,value)

data_long$wave <- as.integer(data_long$wave)
```


# Question 1
```{r Question 1}
## Add a nominal covariate into the model (sex)

#Predicting intercept
model1a <- lmer(PPeerScale ~ sex_01 + (1 | ID), data=data_long)
summary(model1a)

#Predicting intercept and slope
model1b <- lmer(PPeerScale ~ age + sex_01 + (age | ID), data=data_long)
summary(model1b)

#Predicting intercept and slope, with sex centerd
model1c <- lmer(PPeerScale ~ age + sex_c + (age | ID), data=data_long)
summary(model1c)
```
Centering the nominal covariate (sex) did not affect the model at all. However, when time is added into the model, the residual variance is reduced. The estimate for the fixed effect of the covariate (sex) changes in value and interpretation. In model a is it a reflection of the difference of group means, while in model b it is a reflection of the difference the group slopes.


# Question 2
```{r Question 2}
## Add a continuous time-invariant covariate into the model (SES=T1Income_to_Need)

#Predicting intercept
model2a <- lmer(PPeerScale ~ T1Income_to_Need + (1 | ID), data=data_long)
summary(model2a)

#Predicting intercept and slope
model2b <- lmer(PPeerScale ~ age + T1Income_to_Need + (age | ID), data=data_long)
summary(model2b)

#Predicting intercept and slope, with SES centerd
model2c <- lmer(PPeerScale ~ age + T1Income_to_Need_c + (age | ID), data=data_long)
summary(model2c)
```
The fixed effect of the intercept changed from model b to c, since not it reflects the mean SES, rather than reflecting the PPeer score when SES=0.


# Question 3
```{r Question 3}
model1c_aug <- augment(model1c)
model2c_aug <- augment(model2c)

ggplot(model1c_aug, aes(x= age, y = .fitted, color=factor(sex_c))) + 
  geom_point() + 
  stat_smooth(aes(group=factor(sex_c)),method="lm")
  
ggplot(model2c_aug, aes(x= age, y = .fitted, color=T1Income_to_Need_c)) + 
  geom_point() + 
  stat_smooth(aes(group=T1Income_to_Need_c),method="lm")
```


# Question 4
```{r Question 4}
model1_CI <- matrix(ncol=4,nrow=2)
colnames(model1_CI) <- c("","Lower_CI","Estimate","Upper_CI")
model1_CI[,1] <- c("Intercept","Slope") 
model1_CI <- as.data.frame(model1_CI)

model1c_tidy <- tidy(model1c)
model1_CI[1,2:4] <- c(model1c_tidy[1,2]-1.96*model1c_tidy[4,2],model1c_tidy[1,2],model1c_tidy[1,2]+1.96*model1c_tidy[4,2])
model1_CI[2,2:4] <- c(model1c_tidy[2,2]-1.96*model1c_tidy[5,2],model1c_tidy[2,2],model1c_tidy[2,2]+1.96*model1c_tidy[5,2])

kable(model1_CI,digits=2)

model2_CI <- matrix(ncol=4,nrow=2)
colnames(model2_CI) <- c("","Lower_CI","Estimate","Upper_CI")
model2_CI[,1] <- c("Intercept","Slope") 
model2_CI <- as.data.frame(model2_CI)

model2c_tidy <- tidy(model2c)
model2_CI[1,2:4] <- c(model2c_tidy[1,2]-1.96*model2c_tidy[4,2],model2c_tidy[1,2],model2c_tidy[1,2]+1.96*model2c_tidy[4,2])
model2_CI[2,2:4] <- c(model2c_tidy[2,2]-1.96*model2c_tidy[5,2],model2c_tidy[2,2],model2c_tidy[2,2]+1.96*model2c_tidy[5,2])

kable(model2_CI,digits=2)
```


# Question 5
```{r Question 5}
model5 <- lmer(PPeerScale ~ age + T1Income_to_Need_c + sex_c + (age | ID), data=data_long)
summary(model5)
summary(model2c)
```
Now the random effects are taking into account each participants' sex and SES when determining the variability around the intercept and slope. Since the residual variance actually increases slightly from 31.2204 to 31.228 compared to the model that only includd SES, while the variability around the slope (age) and intercept change minimally, we can determine that sex has a minimal effect on the random effects.