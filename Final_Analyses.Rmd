---
title: "Final_Analyses"
author: "Brent Rappaport"
date: "12/6/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo= TRUE, warning= FALSE, cache= TRUE)
library(ggplot2)
library(psych)
library(knitr)
library(Rmisc)
library(tidyverse)
library(car)
library(lsr)
library(lsmeans)
library(R.utils)
library(descr)
library(lme4)
library(nnet)
library(mnlogit)
library(foreign)
library(broom)
library(parallel)
library(lmerTest)
library(semPlot)
library(lavaan) ##need this to run the analyses
library(ggthemes) ##to help make graphs
library(ggrepel) ##to help make graphs
library(papaja)


data_wide <- read.csv("/Users/BrentRappaport/Box Sync/WashU/Classes/Longtudinal Methods/1-descriptives-and-graphs-brappaport/Rappaport_data.csv")
data_wide <- data_wide[,-1]

data_wide <- data_wide %>%
  mutate(MDDPRP100_1 = MDDPRP_1*100,
         MDDPRP100_3 = MDDPRP_3*100,
         MDDPRP100_5 = MDDPRP_5*100,
         MDDPRP100_10 = MDDPRP_10*100,
         MDDPRP100_12 = MDDPRP_12*100,
         MDDPRP100_14 = MDDPRP_14*100,
         MDDPRP100_16 = MDDPRP_16*100,
         MDDPRP100_18 = MDDPRP_18*100)

#Convert data to long form
data_long <- data_wide[,c(1:2,7190:7229)]
data_long <- data_wide %>% 
  mutate(PPeer_1=PPeer1,
         PPeer_3=PPeer3,
         PPeer_5=PPeer5,
         PPeer_10=PPeer10,
         PPeer_12=PPeer12,
         PPeer_14=PPeer14,
         PPeer_16=PPeer16,
         PPeer_18=PPeer18,
         TPeer_1=TPeer1,
         TPeer_3=TPeer3,
         TPeer_5=TPeer5,
         TPeer_10=TPeer10,
         TPeer_12=TPeer12,
         TPeer_14=TPeer14,
         TPeer_16=TPeer16,
         TPeer_18=TPeer18) %>%
  gather(c("age_1","age_3","age_5","age_10","age_12","age_14","age_16","age_18",
           "PPeer_1","PPeer_3","PPeer_5","PPeer_10","PPeer_12","PPeer_14","PPeer_16","PPeer_18",
           "TPeer_1","TPeer_3","TPeer_5","TPeer_10","TPeer_12","TPeer_14","TPeer_16","TPeer_18",
           "MDDCORE_1","MDDCORE_3","MDDCORE_5","MDDCORE_10","MDDCORE_12","MDDCORE_14","MDDCORE_16","MDDCORE_18",
           "MDDPRP_1","MDDPRP_3","MDDPRP_5","MDDPRP_10","MDDPRP_12","MDDPRP_14","MDDPRP_16","MDDPRP_18"), 
         key = "time", value = "value") %>% 
  separate(time, into = c("variable", "wave")) %>%
  spread(variable,value)

data_long$wave <- as.integer(data_long$wave)

#sort by id
data_long <- data_long[order(data_long$ID),] 
```

Descriptive statistics
```{r Descriptive statistics}
#Descriptive stats of the same variables over time
Peer_descriptives <- describe(data_wide[,c("PPeer1","PPeer3","PPeer5","PPeer10","PPeer12",
                       "PPeer14")])[1:4]
Peer_descriptives[,5:7] <- describe(data_wide[,c("TPeer1","TPeer3","TPeer5","TPeer10","TPeer12",
                       "TPeer14")])[2:4]
Peer_descriptives[,8:10] <- describe(data_wide[,c("MDDCORE_1","MDDCORE_3","MDDCORE_5","MDDCORE_10",
                                                 "MDDCORE_12","MDDCORE_14",
                                                 "MDDCORE_16","MDDCORE_18")])[2:4]
Peer_descriptives[,1] <- describe(data_wide[,c("age_1","age_3","age_5","age_10","age_12",
                       "age_14")])[3]
Peer_descriptives

colnames(Peer_descriptives) <- c("Age","Parent-report N","Parent-report Mean","Parent-report SD",
                                 "Teacher-report N","Teacher-report Mean","Teacher-report SD",
                                 "MDD Core Symptoms N","MDD Core Symptoms Mean","MDD Core Symptoms SD")


#Relationship betweem MDDCORE and MDDPRP
cor(data_wide[,c("MDDCORE_1","MDDCORE_3","MDDCORE_5","MDDCORE_10","MDDCORE_12",
                 "MDDCORE_14","MDDCORE_16","MDDCORE_18")],method= "pearson", use="complete.obs")

cor(data_wide[,c("MDDCORE_1","MDDCORE_3","MDDCORE_5","MDDCORE_10","MDDCORE_12",
                 "MDDCORE_14","MDDCORE_16","MDDCORE_18")],
    data_wide[,c("MDDPRP_1","MDDPRP_3","MDDPRP_5","MDDPRP_10","MDDPRP_12",
                 "MDDPRP_14","MDDPRP_16","MDDPRP_18")],method= "pearson", use="complete.obs")

#Relationship of Parent and Teacher report on the Peer scale over time
cor(data_wide[,c("PPeer1","PPeer3","PPeer5","PPeer10","PPeer12",
                 "PPeer14","PPeer16","PPeer18")],
    data_wide[,c("TPeer1","TPeer3","TPeer5","TPeer10","TPeer12",
                 "TPeer14","TPeer16","TPeer18")],method="pearson", use="pairwise.complete.obs")
```

Individual Trajectories
```{r Individual trajectories}
ggplot(data_long,aes(age,PPeer,group=ID)) +
  geom_line(alpha=.5) +
  stat_smooth(aes(group=1),method="lm",size=1,se=T,linetype="longdash") + 
  labs(x="Age",y="Parent-report Peer Scale Score") +
  theme(text=element_text(lineheight=1, face="bold", size=15), 
        legend.position="none")

ggplot(data_long,aes(age,PPeer,group=ID,color=factor(sex))) +
  geom_line(alpha=.5) +
  scale_color_manual(values=c("#377EB8","#E41A1C"),
                     name ="Sex", breaks=c(1,2),
                         labels=c("Male","Female")) +
  stat_smooth(aes(group=factor(sex)),method="lm",size=1,se=T,linetype="longdash",
              formula=y~x+I(x^2),size=1) +
  labs(x="Age",y="Parent-report Peer Scale Score") +
  theme(text=element_text(lineheight=1, face="bold", size=15), 
        legend.position="right")

ggplot(data_long,aes(age,MDDCORE,group=ID)) +
  geom_line(alpha=.5) +
  stat_smooth(aes(group=1),method="lm",size=1,se=T,linetype="longdash") + 
  labs(x="Age",y="MDD Core Symptoms") +
  theme(text=element_text(lineheight=1, face="bold", size=15), 
        legend.position="none")

ggplot(data_long,aes(age,MDDPRP,group=ID)) +
  geom_line(alpha=.5) +
  stat_smooth(aes(group=1),method="lm",size=1,se=T,linetype="longdash") + 
  labs(x="Age",y="Proportion of MDD Symptoms") +
  theme(text=element_text(lineheight=1, face="bold", size=15), 
        legend.position="none")
```

#Internal consistency
```{r Internal consistency}
alpha_Peer_1 <- alpha(data_wide[,c("T1hbq17","T1hbq18r","T1hbq19r","T1hbq21r","T1hbq22r","T1hbq23r","T1hbq24","T1hbq25r","T1hbq26r","T1hbq28r","T1hbq29r")],na.rm=T); alpha_Peer_1

alpha_Peer_3 <- alpha(data_wide[,c("T3hbq17","T3hbq18r","T3hbq19r","T3hbq21r","T3hbq22r","T3hbq23r","T3hbq24","T3hbq26r","T3hbq25r","T3hbq28r","T3hbq29r")],na.rm=T); alpha_Peer_3

alpha_Peer_5 <- alpha(data_wide[,c("T5hbq17","T5hbq18r","T5hbq19r","T5hbq21r","T5hbq22r","T5hbq23r","T5hbq24","T5hbq25r","T5hbq26r","T5hbq28r","T5hbq29r")],na.rm=T); alpha_Peer_5

alpha_Peer_10 <- alpha(data_wide[,c("T6hbqPPeer1","T6hbqPPeer2","T6hbqPPeer3","T6hbqPPeer4","T6hbqPPeer5","T6hbqPPeer6","T6hbqPPeer7","T6hbqPPeer8","T6hbqPPeer9","T6hbqPPeer10","T6hbqPPeer11")],na.rm=T); alpha_Peer_10

alpha_Peer_12 <- alpha(data_wide[,c("T8hbqPPeer1","T8hbqPPeer2","T8hbqPPeer3","T8hbqPPeer4","T8hbqPPeer5","T8hbqPPeer6","T8hbqPPeer7","T8hbqPPeer8","T8hbqPPeer9","T8hbqPPeer10","T8hbqPPeer11")],na.rm=T); alpha_Peer_12

alpha_Peer_14 <- alpha(data_wide[,c("T10hbqh14a","T10hbqh14br","T10hbqh14cr","T10hbqh14dr","T10hbqh14er","T10hbqh14fr","T10hbqh14g","T10hbqh14hr","T10hbqh14ir","T10hbqh14jr","T10hbqh14kr")],na.rm=T); alpha_Peer_14
```

Bivariate multiwave latent change model for Peer score
```{r Bivariate multiwave latent change model for Peer score}
Peer_BMWLC <- '
#Defining the latent variables
Peer_1=~1*PPeer1+1*TPeer1
Peer_2=~1*PPeer3+1*TPeer3
Peer_3=~1*PPeer5+1*TPeer5
Peer_4=~1*PPeer10+1*TPeer10
Peer_5=~1*PPeer12+1*TPeer12
Peer_6=~1*PPeer14+1*TPeer14

MDD_1=~1*MDDCORE_1
MDD_2=~1*MDDCORE_3
MDD_3=~1*MDDCORE_5
MDD_4=~1*MDDCORE_10
MDD_5=~1*MDDCORE_12
MDD_6=~1*MDDCORE_14

#Define regressions
Peer_2 ~ 1*Peer_1
Peer_3 ~ 1*Peer_2
Peer_4 ~ 1*Peer_3
Peer_5 ~ 1*Peer_4
Peer_6 ~ 1*Peer_5

MDD_2 ~ 1*MDD_1
MDD_3 ~ 1*MDD_2
MDD_4 ~ 1*MDD_3
MDD_5 ~ 1*MDD_4
MDD_6 ~ 1*MDD_5

#Define the change score
dPeer_1 =~ 1*Peer_2
dPeer_2 =~ 1*Peer_3
dPeer_3 =~ 1*Peer_4
dPeer_4 =~ 1*Peer_5
dPeer_5 =~ 1*Peer_6
         
dMDD_1 =~ 1*MDD_2
dMDD_2 =~ 1*MDD_3           
dMDD_3 =~ 1*MDD_4
dMDD_4 =~ 1*MDD_5
dMDD_5 =~ 1*MDD_6

#Estimate residual variances
PPeer1~~PPeer1          # This estimates the PPeer residual variances
PPeer3~~PPeer3
PPeer5~~PPeer5
PPeer10~~PPeer10
PPeer12~~PPeer12
PPeer14~~PPeer14

TPeer1~~TPeer1          # This estimates the TPeer residual variances
TPeer3~~TPeer3
TPeer5~~TPeer5
TPeer10~~TPeer10
TPeer12~~TPeer12
TPeer14~~TPeer14

MDDCORE_1~~MDDCORE_1          # This estimates the MDDCORE residual variances
MDDCORE_3~~MDDCORE_3
MDDCORE_5~~MDDCORE_5
MDDCORE_10~~MDDCORE_10
MDDCORE_12~~MDDCORE_12
MDDCORE_14~~MDDCORE_14

#Dynamics

#Estimate the self-feedback parameters
dPeer_1~Peer_1       # This estimates the Peer self-feedback parameter
dPeer_2~Peer_2
dPeer_3~Peer_3
dPeer_4~Peer_4
dPeer_5~Peer_5

dMDD_1~MDD_1       # This estimates the MDD self-feedback parameter
dMDD_2~MDD_2
dMDD_3~MDD_3
dMDD_4~MDD_4
dMDD_5~MDD_5

#Estimate coupling parameter
dMDD_1~Peer_1         # This estimates the Peer to MDD coupling parameter
dMDD_2~Peer_2
dMDD_3~Peer_3
dMDD_4~Peer_4
dMDD_5~Peer_5

dPeer_1~MDD_1         # This estimates the MDD to Peer coupling parameter
dPeer_2~MDD_2
dPeer_3~MDD_3
dPeer_4~MDD_4
dPeer_5~MDD_5

iPeer=~1*Peer_1                   # This defines the Peer intercept measurement model
sPeer=~1*dPeer_1+ 1*dPeer_2+ 1*dPeer_3+ 1*dPeer_4+ 1*dPeer_5 # This defines the Peer slope measurement model
iPeer~1                             # This estimates the Peer intercept intercept (mean)
iPeer~~iPeer                         # This estimates the Peer intercept variance
sPeer~1                             # This estimates the Peer slope intercept
sPeer~~sPeer                         # This estimates the Peer slope variance

iMDD=~1*MDD_1                   # This defines the MDD intercept measurement model
sMDD=~1*dMDD_1+ 1*dMDD_2+ 1*dMDD_3+ 1*dMDD_4+ 1*dMDD_5 # This defines the MDD slope measurement model
iMDD~1                             # This estimates the MDD intercept intercept (mean)
iMDD~~iMDD                         # This estimates the MDD intercept variance
sMDD~1                             # This estimates the MDD slope intercept
sMDD~~sMDD                         # This estimates the MDD slope variance

iMDD~~sMDD                      # This estimates the iMDD sMDD covariance
iMDD~~sPeer                      # This estimates the iMDD sPeer covariance
iMDD~~iPeer                      # This estimates the iMDD iPeer covariance
iPeer~~sPeer                      # This estimates the iPeer sPeer covariance
iPeer~~sMDD                      # This estimates the iPeer sMDD covariance
sPeer~~sMDD                      # This estimates the sPeer sMDD covariance
'

fit_Peer_BMWLC <- lavaan(Peer_BMWLC, data=data_wide, missing="FIML")
inspect(fit_Peer_BMWLC,"cor.lv")

summary(fit_Peer_BMWLC, fit.measures=T, standardized=T)

#Figure 1: Theoretical model
semPaths(fit_Peer_BMWLC, 'mod', curveAdjacent=T, layout="tree", orthogonal=T, rescale=T,
         label.cex=T, label.scale=T, normalize=F, sizeMan=4, sizeInt=2, sizeLat=3, intercepts=F)

semPaths(fit_Peer_BMWLC, 'std', 'est', curveAdjacent=T, layout="tree", orthogonal=T, rescale=T,
         label.cex=T, label.scale=T, normalize=F, sizeMan=3, sizeInt=1, sizeLat=3, intercepts=F)

fit_Peer_BMWLC_sf_c_parameters <- parameterEstimates(fit_Peer_BMWLC)[57:76,]


```
Problematic assumptions: assumes measurement invariance & equal distance between assessments (which is true for the most part)
Can test measurement invariance for all HBQ measures, but not for the MDD measures.
Equal distance assumption should be fine since there is only 1 period that is unequal from the rest. Could try running the model from T6 on to see if the results show up the same.


Bivariate multiwave latent change model for Peer score: Interpersonal Risk model
```{r Bivariate multiwave latent change model for Peer score: Interpersonal Risk model}
PPeer_BMWLC_IR2 <- '
#Defining the latent variables
Peer_1=~1*PPeer1+1*TPeer1
Peer_2=~1*PPeer3+1*TPeer3
Peer_3=~1*PPeer5+1*TPeer5
Peer_4=~1*PPeer10+1*TPeer10
Peer_5=~1*PPeer12+1*TPeer12
Peer_6=~1*PPeer14+1*TPeer14

MDD_1=~1*MDDCORE_1
MDD_2=~1*MDDCORE_3
MDD_3=~1*MDDCORE_5
MDD_4=~1*MDDCORE_10
MDD_5=~1*MDDCORE_12
MDD_6=~1*MDDCORE_14

#Define regressions
Peer_2 ~ 1*Peer_1     # This parameter regresses PPeer3 perfectly on PPeer1
Peer_3 ~ 1*Peer_2
Peer_4 ~ 1*Peer_3
Peer_5 ~ 1*Peer_4
Peer_6 ~ 1*Peer_5

MDD_2 ~ 1*MDD_1     # This parameter regresses MDD_2 perfectly on MDD_1
MDD_3 ~ 1*MDD_2
MDD_4 ~ 1*MDD_3
MDD_5 ~ 1*MDD_4
MDD_6 ~ 1*MDD_5

#Define the change score
dPeer_1 =~ 1*Peer_2        # This defines the change score as measured perfectly by scores on PPeer3
dPeer_2 =~ 1*Peer_3
dPeer_3 =~ 1*Peer_4
dPeer_4 =~ 1*Peer_5
dPeer_5 =~ 1*Peer_6
         
dMDD_1 =~ 1*MDD_2           # This defines the change score as measured perfectly by scores on MDDCORE_3
dMDD_2 =~ 1*MDD_3           
dMDD_3 =~ 1*MDD_4
dMDD_4 =~ 1*MDD_5
dMDD_5 =~ 1*MDD_6

#Estimate residual variances
PPeer1~~PPeer1          # This estimates the PPeer residual variances
PPeer3~~PPeer3
PPeer5~~PPeer5
PPeer10~~PPeer10
PPeer12~~PPeer12
PPeer14~~PPeer14

TPeer1~~TPeer1          # This estimates the TPeer residual variances
TPeer3~~TPeer3
TPeer5~~TPeer5
TPeer10~~TPeer10
TPeer12~~TPeer12
TPeer14~~TPeer14

MDDCORE_1~~MDDCORE_1          # This estimates the MDDCORE residual variances
MDDCORE_3~~MDDCORE_3
MDDCORE_5~~MDDCORE_5
MDDCORE_10~~MDDCORE_10
MDDCORE_12~~MDDCORE_12
MDDCORE_14~~MDDCORE_14

#Dynamics

#Estimate the self-feedback parameters
dPeer_1~F1*Peer_1       # This estimates the Peer self-feedback parameter
dPeer_2~F1*Peer_2
dPeer_3~F1*Peer_3
dPeer_4~F1*Peer_4
dPeer_5~F1*Peer_5

dMDD_1~F2*MDD_1       # This estimates the MDD self-feedback parameter
dMDD_2~F2*MDD_2
dMDD_3~F2*MDD_3
dMDD_4~F2*MDD_4
dMDD_5~F2*MDD_5

#Estimate coupling parameter
dMDD_1~C1*Peer_1         # This estimates the Peer to MDD coupling parameter
dMDD_2~C1*Peer_2
dMDD_3~C1*Peer_3
dMDD_4~C1*Peer_4
dMDD_5~C1*Peer_5

dPeer_1~0*MDD_1         # This estimates the MDD to Peer coupling parameter
dPeer_2~0*MDD_2
dPeer_3~0*MDD_3
dPeer_4~0*MDD_4
dPeer_5~0*MDD_5

iPeer=~1*Peer_1                   # This defines the Peer intercept measurement model
sPeer=~1*dPeer_1+ 1*dPeer_2+ 1*dPeer_3+ 1*dPeer_4+ 1*dPeer_5 # This defines the Peer slope measurement model
iPeer~1                             # This estimates the Peer intercept intercept (mean)
iPeer~~iPeer                         # This estimates the Peer intercept variance
sPeer~1                             # This estimates the Peer slope intercept
sPeer~~sPeer                         # This estimates the Peer slope variance

iMDD=~1*MDD_1                   # This defines the MDD intercept measurement model
sMDD=~1*dMDD_1+ 1*dMDD_2+ 1*dMDD_3+ 1*dMDD_4+ 1*dMDD_5 # This defines the MDD slope measurement model
iMDD~1                             # This estimates the MDD intercept intercept (mean)
iMDD~~iMDD                         # This estimates the MDD intercept variance
sMDD~1                             # This estimates the MDD slope intercept
sMDD~~sMDD                         # This estimates the MDD slope variance

iMDD~~sMDD                      # This estimates the iMDD sMDD covariance
iMDD~~sPeer                      # This estimates the iMDD sPeer covariance
iMDD~~iPeer                      # This estimates the iMDD iPeer covariance
iPeer~~sPeer                      # This estimates the iPeer sPeer covariance
iPeer~~sMDD                      # This estimates the iPeer sMDD covariance
sPeer~~sMDD                      # This estimates the sPeer sMDD covariance
'

fit_PPeer_BMWLC_IR2 <- lavaan(PPeer_BMWLC_IR2, data=data_wide, missing="FIML")
inspect(fit_PPeer_BMWLC_IR2,"cor.lv")

summary(fit_PPeer_BMWLC_IR2, fit.measures=T, standardized=T)

semPaths(fit_PPeer_BMWLC_IR2, 'std', 'est', curveAdjacent=T, layout="tree", orthogonal=T, rescale=T,
         label.cex=T, label.scale=T, normalize=F, sizeMan=3, sizeInt=1, sizeLat=3, intercepts=F)
```


Bivariate multiwave latent change model for Peer score: Interpersonal Scar model
```{r Bivariate multiwave latent change model for Peer score: Interpersonal Scar model}
PPeer_BMWLC_IS2 <- '
#Defining the latent variables
Peer_1=~1*PPeer1+1*TPeer1
Peer_2=~1*PPeer3+1*TPeer3
Peer_3=~1*PPeer5+1*TPeer5
Peer_4=~1*PPeer10+1*TPeer10
Peer_5=~1*PPeer12+1*TPeer12
Peer_6=~1*PPeer14+1*TPeer14

MDD_1=~1*MDDCORE_1
MDD_2=~1*MDDCORE_3
MDD_3=~1*MDDCORE_5
MDD_4=~1*MDDCORE_10
MDD_5=~1*MDDCORE_12
MDD_6=~1*MDDCORE_14

#Define regressions
Peer_2 ~ 1*Peer_1     # This parameter regresses PPeer3 perfectly on PPeer1
Peer_3 ~ 1*Peer_2
Peer_4 ~ 1*Peer_3
Peer_5 ~ 1*Peer_4
Peer_6 ~ 1*Peer_5

MDD_2 ~ 1*MDD_1     # This parameter regresses MDD_2 perfectly on MDD_1
MDD_3 ~ 1*MDD_2
MDD_4 ~ 1*MDD_3
MDD_5 ~ 1*MDD_4
MDD_6 ~ 1*MDD_5

#Define the change score
dPeer_1 =~ 1*Peer_2        # This defines the change score as measured perfectly by scores on PPeer3
dPeer_2 =~ 1*Peer_3
dPeer_3 =~ 1*Peer_4
dPeer_4 =~ 1*Peer_5
dPeer_5 =~ 1*Peer_6

dMDD_1 =~ 1*MDD_2           # This defines the change score as measured perfectly by scores on MDDCORE_3
dMDD_2 =~ 1*MDD_3           
dMDD_3 =~ 1*MDD_4
dMDD_4 =~ 1*MDD_5
dMDD_5 =~ 1*MDD_6

#Estimate residual variances
PPeer1~~PPeer1          # This estimates the PPeer residual variances
PPeer3~~PPeer3
PPeer5~~PPeer5
PPeer10~~PPeer10
PPeer12~~PPeer12
PPeer14~~PPeer14

TPeer1~~TPeer1          # This estimates the TPeer residual variances
TPeer3~~TPeer3
TPeer5~~TPeer5
TPeer10~~TPeer10
TPeer12~~TPeer12
TPeer14~~TPeer14

MDDCORE_1~~MDDCORE_1          # This estimates the MDDCORE residual variances
MDDCORE_3~~MDDCORE_3
MDDCORE_5~~MDDCORE_5
MDDCORE_10~~MDDCORE_10
MDDCORE_12~~MDDCORE_12
MDDCORE_14~~MDDCORE_14

#Dynamics

#Estimate the self-feedback parameters
dPeer_1~F1*Peer_1       # This estimates the Peer self-feedback parameter
dPeer_2~F1*Peer_2
dPeer_3~F1*Peer_3
dPeer_4~F1*Peer_4
dPeer_5~F1*Peer_5

dMDD_1~F2*MDD_1       # This estimates the MDD self-feedback parameter
dMDD_2~F2*MDD_2
dMDD_3~F2*MDD_3
dMDD_4~F2*MDD_4
dMDD_5~F2*MDD_5

#Estimate coupling parameter
dMDD_1~0*Peer_1         # This estimates the Peer to MDD coupling parameter
dMDD_2~0*Peer_2
dMDD_3~0*Peer_3
dMDD_4~0*Peer_4
dMDD_5~0*Peer_5

dPeer_1~C2*MDD_1         # This estimates the MDD to Peer coupling parameter
dPeer_2~C2*MDD_2
dPeer_3~C2*MDD_3
dPeer_4~C2*MDD_4
dPeer_5~C2*MDD_5

iPeer=~1*Peer_1                   # This defines the Peer intercept measurement model
sPeer=~1*dPeer_1+ 1*dPeer_2+ 1*dPeer_3+ 1*dPeer_4+ 1*dPeer_5 # This defines the Peer slope measurement model
iPeer~1                             # This estimates the Peer intercept intercept (mean)
iPeer~~iPeer                         # This estimates the Peer intercept variance
sPeer~1                             # This estimates the Peer slope intercept
sPeer~~sPeer                         # This estimates the Peer slope variance

iMDD=~1*MDD_1                   # This defines the MDD intercept measurement model
sMDD=~1*dMDD_1+ 1*dMDD_2+ 1*dMDD_3+ 1*dMDD_4+ 1*dMDD_5 # This defines the MDD slope measurement model
iMDD~1                             # This estimates the MDD intercept intercept (mean)
iMDD~~iMDD                         # This estimates the MDD intercept variance
sMDD~1                             # This estimates the MDD slope intercept
sMDD~~sMDD                         # This estimates the MDD slope variance

iMDD~~sMDD                      # This estimates the iMDD sMDD covariance
iMDD~~sPeer                      # This estimates the iMDD sPeer covariance
iMDD~~iPeer                      # This estimates the iMDD iPeer covariance
iPeer~~sPeer                      # This estimates the iPeer sPeer covariance
iPeer~~sMDD                      # This estimates the iPeer sMDD covariance
sPeer~~sMDD                      # This estimates the sPeer sMDD covariance
'

fit_PPeer_BMWLC_IS2 <- lavaan(PPeer_BMWLC_IS2, data=data_wide, missing="FIML")
inspect(fit_PPeer_BMWLC_IS2,"cor.lv")

summary(fit_PPeer_BMWLC_IS2, fit.measures=T, standardized=T)

semPaths(fit_PPeer_BMWLC_IS2, 'std', 'est', curveAdjacent=T, layout="tree", orthogonal=T, rescale=T,
         label.cex=T, label.scale=T, normalize=F, sizeMan=3, sizeInt=1, sizeLat=3, intercepts=F)
```



Bivariate multiwave latent change model for Peer score: Transactional model
```{r Bivariate multiwave latent change model for Peer score: Transactional model}
PPeer_BMWLC_T2 <- '
#Defining the latent variables
Peer_1=~1*PPeer1+1*TPeer1
Peer_2=~1*PPeer3+1*TPeer3
Peer_3=~1*PPeer5+1*TPeer5
Peer_4=~1*PPeer10+1*TPeer10
Peer_5=~1*PPeer12+1*TPeer12
Peer_6=~1*PPeer14+1*TPeer14

MDD_1=~1*MDDCORE_1
MDD_2=~1*MDDCORE_3
MDD_3=~1*MDDCORE_5
MDD_4=~1*MDDCORE_10
MDD_5=~1*MDDCORE_12
MDD_6=~1*MDDCORE_14

#Define regressions
Peer_2 ~ 1*Peer_1     # This parameter regresses PPeer3 perfectly on PPeer1
Peer_3 ~ 1*Peer_2
Peer_4 ~ 1*Peer_3
Peer_5 ~ 1*Peer_4
Peer_6 ~ 1*Peer_5

MDD_2 ~ 1*MDD_1     # This parameter regresses MDD_2 perfectly on MDD_1
MDD_3 ~ 1*MDD_2
MDD_4 ~ 1*MDD_3
MDD_5 ~ 1*MDD_4
MDD_6 ~ 1*MDD_5

#Define the change score
dPeer_1 =~ 1*Peer_2        # This defines the change score as measured perfectly by scores on PPeer3
dPeer_2 =~ 1*Peer_3
dPeer_3 =~ 1*Peer_4
dPeer_4 =~ 1*Peer_5
dPeer_5 =~ 1*Peer_6
         
dMDD_1 =~ 1*MDD_2           # This defines the change score as measured perfectly by scores on MDDCORE_3
dMDD_2 =~ 1*MDD_3           
dMDD_3 =~ 1*MDD_4
dMDD_4 =~ 1*MDD_5
dMDD_5 =~ 1*MDD_6

#Estimate residual variances
PPeer1~~PPeer1          # This estimates the PPeer residual variances
PPeer3~~PPeer3
PPeer5~~PPeer5
PPeer10~~PPeer10
PPeer12~~PPeer12
PPeer14~~PPeer14

TPeer1~~TPeer1          # This estimates the TPeer residual variances
TPeer3~~TPeer3
TPeer5~~TPeer5
TPeer10~~TPeer10
TPeer12~~TPeer12
TPeer14~~TPeer14

MDDCORE_1~~MDDCORE_1          # This estimates the MDDCORE residual variances
MDDCORE_3~~MDDCORE_3
MDDCORE_5~~MDDCORE_5
MDDCORE_10~~MDDCORE_10
MDDCORE_12~~MDDCORE_12
MDDCORE_14~~MDDCORE_14

#Dynamics

#Estimate the self-feedback parameters
dPeer_1~F1*Peer_1       # This estimates the Peer self-feedback parameter
dPeer_2~F1*Peer_2
dPeer_3~F1*Peer_3
dPeer_4~F1*Peer_4
dPeer_5~F1*Peer_5

dMDD_1~F2*MDD_1       # This estimates the MDD self-feedback parameter
dMDD_2~F2*MDD_2
dMDD_3~F2*MDD_3
dMDD_4~F2*MDD_4
dMDD_5~F2*MDD_5

#Estimate coupling parameter
dMDD_1~C1*Peer_1         # This estimates the Peer to MDD coupling parameter
dMDD_2~C1*Peer_2
dMDD_3~C1*Peer_3
dMDD_4~C1*Peer_4
dMDD_5~C1*Peer_5

dPeer_1~C2*MDD_1         # This estimates the MDD to Peer coupling parameter
dPeer_2~C2*MDD_2
dPeer_3~C2*MDD_3
dPeer_4~C2*MDD_4
dPeer_5~C2*MDD_5

iPeer=~1*Peer_1                   # This defines the Peer intercept measurement model
sPeer=~1*dPeer_1+ 1*dPeer_2+ 1*dPeer_3+ 1*dPeer_4+ 1*dPeer_5 # This defines the Peer slope measurement model
iPeer~1                             # This estimates the Peer intercept intercept (mean)
iPeer~~iPeer                         # This estimates the Peer intercept variance
sPeer~1                             # This estimates the Peer slope intercept
sPeer~~sPeer                         # This estimates the Peer slope variance

iMDD=~1*MDD_1                   # This defines the MDD intercept measurement model
sMDD=~1*dMDD_1+ 1*dMDD_2+ 1*dMDD_3+ 1*dMDD_4+ 1*dMDD_5 # This defines the MDD slope measurement model
iMDD~1                             # This estimates the MDD intercept intercept (mean)
iMDD~~iMDD                         # This estimates the MDD intercept variance
sMDD~1                             # This estimates the MDD slope intercept
sMDD~~sMDD                         # This estimates the MDD slope variance

iMDD~~sMDD                      # This estimates the iMDD sMDD covariance
iMDD~~sPeer                      # This estimates the iMDD sPeer covariance
iMDD~~iPeer                      # This estimates the iMDD iPeer covariance
iPeer~~sPeer                      # This estimates the iPeer sPeer covariance
iPeer~~sMDD                      # This estimates the iPeer sMDD covariance
sPeer~~sMDD                      # This estimates the sPeer sMDD covariance
'

fit_PPeer_BMWLC_T2 <- lavaan(PPeer_BMWLC_T2, data=data_wide, missing="FIML",
                             control=list(iter.min=10000))

summary(fit_PPeer_BMWLC_T2, fit.measures=T, standardized=T)

semPaths(fit_PPeer_BMWLC_T2, 'std', 'est', curveAdjacent=T, layout="tree", orthogonal=T, rescale=T,
         label.cex=T, label.scale=T, normalize=F, sizeMan=3, sizeInt=1, sizeLat=3, intercepts=F)
```


Bivariate multiwave latent change model for Peer score with parent-report item level observed variables
```{r Bivariate multiwave latent change model for Peer score with parent-report item level observed variables}
PPeer_BMWLC_il <- '
#Defining the latent variables

Peer_1 =~ 1*T1hbq17+1*T1hbq18r+1*T1hbq19r+1*T1hbq21r+1*T1hbq22r+1*T1hbq23r+1*T1hbq24+1*T1hbq25r+1*T1hbq26r+1*T1hbq28r+1*T1hbq29r
Peer_2 =~ 1*T3hbq17+1*T3hbq18r+1*T3hbq19r+1*T3hbq21r+1*T3hbq22r+1*T3hbq23r+1*T3hbq24+1*T3hbq26r+1*T3hbq25r+1*T3hbq28r+1*T3hbq29r
Peer_3 =~ 1*T5hbq17+1*T5hbq18r+1*T5hbq19r+1*T5hbq21r+1*T5hbq22r+1*T5hbq23r+1*T5hbq24+1*T5hbq25r+1*T5hbq26r+1*T5hbq28r+1*T5hbq29r
Peer_4 =~ 1*T6hbqPPeer1+1*T6hbqPPeer2+1*T6hbqPPeer3+1*T6hbqPPeer4+1*T6hbqPPeer5+1*T6hbqPPeer6+1*T6hbqPPeer7+1*T6hbqPPeer8+1*T6hbqPPeer9+1*T6hbqPPeer10+1*T6hbqPPeer11
Peer_5 =~ 1*T8hbqPPeer1+1*T8hbqPPeer2+1*T8hbqPPeer3+1*T8hbqPPeer4+1*T8hbqPPeer5+1*T8hbqPPeer6+1*T8hbqPPeer7+1*T8hbqPPeer8+1*T8hbqPPeer9+1*T8hbqPPeer10+1*T8hbqPPeer11
Peer_6 =~ 1*T10hbqh14a+1*T10hbqh14br+1*T10hbqh14cr+1*T10hbqh14dr+1*T10hbqh14er+1*T10hbqh14fr+1*T10hbqh14g+1*T10hbqh14hr+1*T10hbqh14ir+1*T10hbqh14jr+1*T10hbqh14kr

MDD_1 =~ 1*MDDCORE_1
MDD_2 =~ 1*MDDCORE_3
MDD_3 =~ 1*MDDCORE_5
MDD_4 =~ 1*MDDCORE_10
MDD_5 =~ 1*MDDCORE_12
MDD_6 =~ 1*MDDCORE_14

#Define regressions
Peer_2 ~ 1*Peer_1
Peer_3 ~ 1*Peer_2
Peer_4 ~ 1*Peer_3
Peer_5 ~ 1*Peer_4
Peer_6 ~ 1*Peer_5

MDD_2 ~ 1*MDD_1
MDD_3 ~ 1*MDD_2
MDD_4 ~ 1*MDD_3
MDD_5 ~ 1*MDD_4
MDD_6 ~ 1*MDD_5

#Define the change score
dPeer_1 =~ 1*Peer_2        # This defines the change score as measured perfectly by scores on PPeer2
dPeer_2 =~ 1*Peer_3
dPeer_3 =~ 1*Peer_4
dPeer_4 =~ 1*Peer_5
dPeer_5 =~ 1*Peer_6
         
dMDD_1 =~ 1*MDD_2           # This defines the change score as measured perfectly by scores on MDDCORE_2
dMDD_2 =~ 1*MDD_3           
dMDD_3 =~ 1*MDD_4
dMDD_4 =~ 1*MDD_5
dMDD_5 =~ 1*MDD_6

#Estimate residual variances
##Parent-report
###Item 1
T1hbq17 ~~ T1hbq17
T3hbq17 ~~ T3hbq17
T5hbq17 ~~ T5hbq17
T6hbqPPeer1 ~~ T6hbqPPeer1
T8hbqPPeer1 ~~ T8hbqPPeer1
T10hbqh14a ~~ T10hbqh14a

###Item 2
T1hbq18r ~~ T1hbq18r
T3hbq18r ~~ T3hbq18r
T5hbq18r ~~ T5hbq18r
T6hbqPPeer2 ~~ T6hbqPPeer2
T8hbqPPeer2 ~~ T8hbqPPeer2
T10hbqh14br ~~ T10hbqh14br

###Item 3
T1hbq19r ~~ T1hbq19r
T3hbq19r ~~ T3hbq19r
T5hbq19r ~~ T5hbq19r
T6hbqPPeer3 ~~ T6hbqPPeer3
T8hbqPPeer3 ~~ T8hbqPPeer3
T10hbqh14cr ~~ T10hbqh14cr

###Item 4
T1hbq21r ~~ T1hbq21r
T3hbq21r ~~ T3hbq21r
T5hbq21r ~~ T5hbq21r
T6hbqPPeer4 ~~ T6hbqPPeer4
T8hbqPPeer4 ~~ T8hbqPPeer4
T10hbqh14dr ~~ T10hbqh14dr

###Item 5
T1hbq22r ~~ T1hbq22r
T3hbq22r ~~ T3hbq22r
T5hbq22r ~~ T5hbq22r
T6hbqPPeer5 ~~ T6hbqPPeer5
T8hbqPPeer5 ~~ T8hbqPPeer5
T10hbqh14er ~~ T10hbqh14er

###Item 6
T1hbq23r ~~ T1hbq23r
T3hbq23r ~~ T3hbq23r
T5hbq23r ~~ T5hbq23r
T6hbqPPeer6 ~~ T6hbqPPeer6
T8hbqPPeer6 ~~ T8hbqPPeer6
T10hbqh14fr ~~ T10hbqh14fr

###Item 7
T1hbq24 ~~ T1hbq24
T3hbq24 ~~ T3hbq24
T5hbq24 ~~ T5hbq24
T6hbqPPeer7 ~~ T6hbqPPeer7
T8hbqPPeer7 ~~ T8hbqPPeer7
T10hbqh14g ~~ T10hbqh14g

###Item 8
T1hbq25r ~~ T1hbq25r
T3hbq26r ~~ T3hbq26r
T5hbq25r ~~ T5hbq25r
T6hbqPPeer8 ~~ T6hbqPPeer8
T8hbqPPeer8 ~~ T8hbqPPeer8
T10hbqh14hr ~~ T10hbqh14hr

###Item 9
T1hbq26r ~~ T1hbq26r
T3hbq25r ~~ T3hbq25r
T5hbq26r ~~ T5hbq26r
T6hbqPPeer9 ~~ T6hbqPPeer9
T8hbqPPeer9 ~~ T8hbqPPeer9
T10hbqh14ir ~~ T10hbqh14ir

###Item 10
T1hbq28r ~~ T1hbq28r
T3hbq28r ~~ T3hbq28r
T5hbq28r ~~ T5hbq28r
T6hbqPPeer10 ~~ T6hbqPPeer10
T8hbqPPeer10 ~~ T8hbqPPeer10
T10hbqh14jr ~~ T10hbqh14jr

###Item 11
T1hbq29r ~~ T1hbq29r
T3hbq29r ~~ T3hbq29r
T5hbq29r ~~ T5hbq29r
T6hbqPPeer11 ~~ T6hbqPPeer11
T8hbqPPeer11 ~~ T8hbqPPeer11
T10hbqh14kr ~~ T10hbqh14kr

MDDCORE_1 ~~ MDDCORE_1          # This estimates the MDDCORE residual variances
MDDCORE_3 ~~ MDDCORE_3
MDDCORE_5 ~~ MDDCORE_5
MDDCORE_10 ~~ MDDCORE_10
MDDCORE_12 ~~ MDDCORE_12
MDDCORE_14 ~~ MDDCORE_14

#Dynamics

#Estimate the self-feedback parameters
dPeer_1~Peer_1       # This estimates the Peer self-feedback parameter
dPeer_2~Peer_2
dPeer_3~Peer_3
dPeer_4~Peer_4
dPeer_5~Peer_5

dMDD_1~MDD_1       # This estimates the MDD self-feedback parameter
dMDD_2~MDD_2
dMDD_3~MDD_3
dMDD_4~MDD_4
dMDD_5~MDD_5

#Estimate coupling parameter
dMDD_1~Peer_1         # This estimates the Peer to MDD coupling parameter
dMDD_2~Peer_2
dMDD_3~Peer_3
dMDD_4~Peer_4
dMDD_5~Peer_5

dPeer_1~MDD_1         # This estimates the MDD to Peer coupling parameter
dPeer_2~MDD_2
dPeer_3~MDD_3
dPeer_4~MDD_4
dPeer_5~MDD_5

iPeer=~1*Peer_1                   # This defines the Peer intercept measurement model
sPeer=~1*dPeer_1+ 1*dPeer_2+ 1*dPeer_3+ 1*dPeer_4+ 1*dPeer_5 # This defines the Peer slope measurement model
iPeer~1                             # This estimates the Peer intercept intercept (mean)
iPeer~~iPeer                         # This estimates the Peer intercept variance
sPeer~1                             # This estimates the Peer slope intercept
sPeer~~sPeer                         # This estimates the Peer slope variance

iMDD=~1*MDD_1                   # This defines the MDD intercept measurement model
sMDD=~1*dMDD_1+ 1*dMDD_2+ 1*dMDD_3+ 1*dMDD_4+ 1*dMDD_5 # This defines the MDD slope measurement model
iMDD~1                             # This estimates the MDD intercept intercept (mean)
iMDD~~iMDD                         # This estimates the MDD intercept variance
sMDD~1                             # This estimates the MDD slope intercept
sMDD~~sMDD                         # This estimates the MDD slope variance

iMDD~~sMDD                      # This estimates the iMDD sMDD covariance
iMDD~~sPeer                      # This estimates the iMDD sPeer covariance
iMDD~~iPeer                      # This estimates the iMDD iPeer covariance
iPeer~~sPeer                      # This estimates the iPeer sPeer covariance
iPeer~~sMDD                      # This estimates the iPeer sMDD covariance
sPeer~~sMDD                      # This estimates the sPeer sMDD covariance
'

fit_PPeer_BMWLC_il <- lavaan(PPeer_BMWLC_il, data=data_wide, missing="FIML",
                            control=list(eval.max=40000, iter.min=10000))

summary(fit_PPeer_BMWLC_il, fit.measures=T, standardized=T)

semPaths(fit_PPeer_BMWLC_il, 'std', 'est', curveAdjacent=T, layout="tree", orthogonal=T, rescale=T,
         label.cex=T, label.scale=T, normalize=F, sizeMan=3, sizeInt=1, sizeLat=3, intercepts=F)
```


Bivariate multiwave latent change model for Peer score for Interpersonal Risk model
```{r Bivariate multiwave latent change model for Peer score for Interpersonal Risk model}
PPeer_BMWLC_IR <- '
#Defining the latent variables

Peer_1 =~ 1*T1hbq17+1*T1hbq18r+1*T1hbq19r+1*T1hbq21r+1*T1hbq22r+1*T1hbq23r+1*T1hbq24+1*T1hbq25r+1*T1hbq26r+1*T1hbq28r+1*T1hbq29r
Peer_2 =~ 1*T3hbq17+1*T3hbq18r+1*T3hbq19r+1*T3hbq21r+1*T3hbq22r+1*T3hbq23r+1*T3hbq24+1*T3hbq26r+1*T3hbq25r+1*T3hbq28r+1*T3hbq29r
Peer_3 =~ 1*T5hbq17+1*T5hbq18r+1*T5hbq19r+1*T5hbq21r+1*T5hbq22r+1*T5hbq23r+1*T5hbq24+1*T5hbq25r+1*T5hbq26r+1*T5hbq28r+1*T5hbq29r
Peer_4 =~ 1*T6hbqPPeer1+1*T6hbqPPeer2+1*T6hbqPPeer3+1*T6hbqPPeer4+1*T6hbqPPeer5+1*T6hbqPPeer6+1*T6hbqPPeer7+1*T6hbqPPeer8+1*T6hbqPPeer9+1*T6hbqPPeer10+1*T6hbqPPeer11
Peer_5 =~ 1*T8hbqPPeer1+1*T8hbqPPeer2+1*T8hbqPPeer3+1*T8hbqPPeer4+1*T8hbqPPeer5+1*T8hbqPPeer6+1*T8hbqPPeer7+1*T8hbqPPeer8+1*T8hbqPPeer9+1*T8hbqPPeer10+1*T8hbqPPeer11
Peer_6 =~ 1*T10hbqh14a+1*T10hbqh14br+1*T10hbqh14cr+1*T10hbqh14dr+1*T10hbqh14er+1*T10hbqh14fr+1*T10hbqh14g+1*T10hbqh14hr+1*T10hbqh14ir+1*T10hbqh14jr+1*T10hbqh14kr

MDD_1 =~ 1*MDDCORE_1
MDD_2 =~ 1*MDDCORE_3
MDD_3 =~ 1*MDDCORE_5
MDD_4 =~ 1*MDDCORE_10
MDD_5 =~ 1*MDDCORE_12
MDD_6 =~ 1*MDDCORE_14

#Define regressions
Peer_2 ~ 1*Peer_1
Peer_3 ~ 1*Peer_2
Peer_4 ~ 1*Peer_3
Peer_5 ~ 1*Peer_4
Peer_6 ~ 1*Peer_5

MDD_2 ~ 1*MDD_1
MDD_3 ~ 1*MDD_2
MDD_4 ~ 1*MDD_3
MDD_5 ~ 1*MDD_4
MDD_6 ~ 1*MDD_5

#Define the change score
dPeer_1 =~ 1*Peer_2        # This defines the change score as measured perfectly by scores on PPeer2
dPeer_2 =~ 1*Peer_3
dPeer_3 =~ 1*Peer_4
dPeer_4 =~ 1*Peer_5
dPeer_5 =~ 1*Peer_6
         
dMDD_1 =~ 1*MDD_2           # This defines the change score as measured perfectly by scores on MDDCORE_2
dMDD_2 =~ 1*MDD_3           
dMDD_3 =~ 1*MDD_4
dMDD_4 =~ 1*MDD_5
dMDD_5 =~ 1*MDD_6

#Estimate residual variances
##Parent-report
###Item 1
T1hbq17 ~~ T1hbq17
T3hbq17 ~~ T3hbq17
T5hbq17 ~~ T5hbq17
T6hbqPPeer1 ~~ T6hbqPPeer1
T8hbqPPeer1 ~~ T8hbqPPeer1
T10hbqh14a ~~ T10hbqh14a

###Item 2
T1hbq18r ~~ T1hbq18r
T3hbq18r ~~ T3hbq18r
T5hbq18r ~~ T5hbq18r
T6hbqPPeer2 ~~ T6hbqPPeer2
T8hbqPPeer2 ~~ T8hbqPPeer2
T10hbqh14br ~~ T10hbqh14br

###Item 3
T1hbq19r ~~ T1hbq19r
T3hbq19r ~~ T3hbq19r
T5hbq19r ~~ T5hbq19r
T6hbqPPeer3 ~~ T6hbqPPeer3
T8hbqPPeer3 ~~ T8hbqPPeer3
T10hbqh14cr ~~ T10hbqh14cr

###Item 4
T1hbq21r ~~ T1hbq21r
T3hbq21r ~~ T3hbq21r
T5hbq21r ~~ T5hbq21r
T6hbqPPeer4 ~~ T6hbqPPeer4
T8hbqPPeer4 ~~ T8hbqPPeer4
T10hbqh14dr ~~ T10hbqh14dr

###Item 5
T1hbq22r ~~ T1hbq22r
T3hbq22r ~~ T3hbq22r
T5hbq22r ~~ T5hbq22r
T6hbqPPeer5 ~~ T6hbqPPeer5
T8hbqPPeer5 ~~ T8hbqPPeer5
T10hbqh14er ~~ T10hbqh14er

###Item 6
T1hbq23r ~~ T1hbq23r
T3hbq23r ~~ T3hbq23r
T5hbq23r ~~ T5hbq23r
T6hbqPPeer6 ~~ T6hbqPPeer6
T8hbqPPeer6 ~~ T8hbqPPeer6
T10hbqh14fr ~~ T10hbqh14fr

###Item 7
T1hbq24 ~~ T1hbq24
T3hbq24 ~~ T3hbq24
T5hbq24 ~~ T5hbq24
T6hbqPPeer7 ~~ T6hbqPPeer7
T8hbqPPeer7 ~~ T8hbqPPeer7
T10hbqh14g ~~ T10hbqh14g

###Item 8
T1hbq25r ~~ T1hbq25r
T3hbq26r ~~ T3hbq26r
T5hbq25r ~~ T5hbq25r
T6hbqPPeer8 ~~ T6hbqPPeer8
T8hbqPPeer8 ~~ T8hbqPPeer8
T10hbqh14hr ~~ T10hbqh14hr

###Item 9
T1hbq26r ~~ T1hbq26r
T3hbq25r ~~ T3hbq25r
T5hbq26r ~~ T5hbq26r
T6hbqPPeer9 ~~ T6hbqPPeer9
T8hbqPPeer9 ~~ T8hbqPPeer9
T10hbqh14ir ~~ T10hbqh14ir

###Item 10
T1hbq28r ~~ T1hbq28r
T3hbq28r ~~ T3hbq28r
T5hbq28r ~~ T5hbq28r
T6hbqPPeer10 ~~ T6hbqPPeer10
T8hbqPPeer10 ~~ T8hbqPPeer10
T10hbqh14jr ~~ T10hbqh14jr

###Item 11
T1hbq29r ~~ T1hbq29r
T3hbq29r ~~ T3hbq29r
T5hbq29r ~~ T5hbq29r
T6hbqPPeer11 ~~ T6hbqPPeer11
T8hbqPPeer11 ~~ T8hbqPPeer11
T10hbqh14kr ~~ T10hbqh14kr

MDDCORE_1 ~~ MDDCORE_1          # This estimates the MDDCORE residual variances
MDDCORE_3 ~~ MDDCORE_3
MDDCORE_5 ~~ MDDCORE_5
MDDCORE_10 ~~ MDDCORE_10
MDDCORE_12 ~~ MDDCORE_12
MDDCORE_14 ~~ MDDCORE_14

#Dynamics

#Estimate the self-feedback parameters
dPeer_1~F1*Peer_1       # This estimates the Peer self-feedback parameter
dPeer_2~F1*Peer_2
dPeer_3~F1*Peer_3
dPeer_4~F1*Peer_4
dPeer_5~F1*Peer_5

dMDD_1~F2*MDD_1       # This estimates the MDD self-feedback parameter
dMDD_2~F2*MDD_2
dMDD_3~F2*MDD_3
dMDD_4~F2*MDD_4
dMDD_5~F2*MDD_5

#Estimate coupling parameter
dMDD_1~C1*Peer_1         # This estimates the Peer to MDD coupling parameter
dMDD_2~C1*Peer_2
dMDD_3~C1*Peer_3
dMDD_4~C1*Peer_4
dMDD_5~C1*Peer_5

dPeer_1~0*MDD_1         # This estimates the MDD to Peer coupling parameter
dPeer_2~0*MDD_2
dPeer_3~0*MDD_3
dPeer_4~0*MDD_4
dPeer_5~0*MDD_5

iPeer=~1*Peer_1                   # This defines the Peer intercept measurement model
sPeer=~1*dPeer_1+ 1*dPeer_2+ 1*dPeer_3+ 1*dPeer_4+ 1*dPeer_5 # This defines the Peer slope measurement model
iPeer~1                             # This estimates the Peer intercept intercept (mean)
iPeer~~iPeer                         # This estimates the Peer intercept variance
sPeer~1                             # This estimates the Peer slope intercept
sPeer~~sPeer                         # This estimates the Peer slope variance

iMDD=~1*MDD_1                   # This defines the MDD intercept measurement model
sMDD=~1*dMDD_1+ 1*dMDD_2+ 1*dMDD_3+ 1*dMDD_4+ 1*dMDD_5 # This defines the MDD slope measurement model
iMDD~1                             # This estimates the MDD intercept intercept (mean)
iMDD~~iMDD                         # This estimates the MDD intercept variance
sMDD~1                             # This estimates the MDD slope intercept
sMDD~~sMDD                         # This estimates the MDD slope variance

iMDD~~sMDD                      # This estimates the iMDD sMDD covariance
iMDD~~sPeer                      # This estimates the iMDD sPeer covariance
iMDD~~iPeer                      # This estimates the iMDD iPeer covariance
iPeer~~sPeer                      # This estimates the iPeer sPeer covariance
iPeer~~sMDD                      # This estimates the iPeer sMDD covariance
sPeer~~sMDD                      # This estimates the sPeer sMDD covariance
'

fit_PPeer_BMWLC_IR <- lavaan(PPeer_BMWLC_IR, data=data_wide, missing="FIML")
inspect(fit_PPeer_BMWLC_IR,"cor.lv")

summary(fit_PPeer_BMWLC_IR, fit.measures=T, standardized=T)

semPaths(fit_PPeer_BMWLC_IR, 'std', 'est', curveAdjacent=T, layout="tree", orthogonal=T, rescale=T,
         label.cex=T, label.scale=T, normalize=F, sizeMan=3, sizeInt=1, sizeLat=3, intercepts=F)

IR_fit <- fitMeasures(fit_PPeer_BMWLC_IR, c("chisq","df","rmsea"))
```


Bivariate multiwave latent change model for Peer score for Interpersonal Scar model
```{r Bivariate multiwave latent change model for Peer score for Interpersonal Scar model}
PPeer_BMWLC_IS <- '
#Defining the latent variables

Peer_1 =~ 1*T1hbq17+1*T1hbq18r+1*T1hbq19r+1*T1hbq21r+1*T1hbq22r+1*T1hbq23r+1*T1hbq24+1*T1hbq25r+1*T1hbq26r+1*T1hbq28r+1*T1hbq29r
Peer_2 =~ 1*T3hbq17+1*T3hbq18r+1*T3hbq19r+1*T3hbq21r+1*T3hbq22r+1*T3hbq23r+1*T3hbq24+1*T3hbq26r+1*T3hbq25r+1*T3hbq28r+1*T3hbq29r
Peer_3 =~ 1*T5hbq17+1*T5hbq18r+1*T5hbq19r+1*T5hbq21r+1*T5hbq22r+1*T5hbq23r+1*T5hbq24+1*T5hbq25r+1*T5hbq26r+1*T5hbq28r+1*T5hbq29r
Peer_4 =~ 1*T6hbqPPeer1+1*T6hbqPPeer2+1*T6hbqPPeer3+1*T6hbqPPeer4+1*T6hbqPPeer5+1*T6hbqPPeer6+1*T6hbqPPeer7+1*T6hbqPPeer8+1*T6hbqPPeer9+1*T6hbqPPeer10+1*T6hbqPPeer11
Peer_5 =~ 1*T8hbqPPeer1+1*T8hbqPPeer2+1*T8hbqPPeer3+1*T8hbqPPeer4+1*T8hbqPPeer5+1*T8hbqPPeer6+1*T8hbqPPeer7+1*T8hbqPPeer8+1*T8hbqPPeer9+1*T8hbqPPeer10+1*T8hbqPPeer11
Peer_6 =~ 1*T10hbqh14a+1*T10hbqh14br+1*T10hbqh14cr+1*T10hbqh14dr+1*T10hbqh14er+1*T10hbqh14fr+1*T10hbqh14g+1*T10hbqh14hr+1*T10hbqh14ir+1*T10hbqh14jr+1*T10hbqh14kr

MDD_1 =~ 1*MDDCORE_1
MDD_2 =~ 1*MDDCORE_3
MDD_3 =~ 1*MDDCORE_5
MDD_4 =~ 1*MDDCORE_10
MDD_5 =~ 1*MDDCORE_12
MDD_6 =~ 1*MDDCORE_14

#Define regressions
Peer_2 ~ 1*Peer_1
Peer_3 ~ 1*Peer_2
Peer_4 ~ 1*Peer_3
Peer_5 ~ 1*Peer_4
Peer_6 ~ 1*Peer_5

MDD_2 ~ 1*MDD_1
MDD_3 ~ 1*MDD_2
MDD_4 ~ 1*MDD_3
MDD_5 ~ 1*MDD_4
MDD_6 ~ 1*MDD_5

#Define the change score
dPeer_1 =~ 1*Peer_2        # This defines the change score as measured perfectly by scores on PPeer2
dPeer_2 =~ 1*Peer_3
dPeer_3 =~ 1*Peer_4
dPeer_4 =~ 1*Peer_5
dPeer_5 =~ 1*Peer_6
         
dMDD_1 =~ 1*MDD_2           # This defines the change score as measured perfectly by scores on MDDCORE_2
dMDD_2 =~ 1*MDD_3           
dMDD_3 =~ 1*MDD_4
dMDD_4 =~ 1*MDD_5
dMDD_5 =~ 1*MDD_6

#Estimate residual variances
##Parent-report
###Item 1
T1hbq17 ~~ T1hbq17
T3hbq17 ~~ T3hbq17
T5hbq17 ~~ T5hbq17
T6hbqPPeer1 ~~ T6hbqPPeer1
T8hbqPPeer1 ~~ T8hbqPPeer1
T10hbqh14a ~~ T10hbqh14a

###Item 2
T1hbq18r ~~ T1hbq18r
T3hbq18r ~~ T3hbq18r
T5hbq18r ~~ T5hbq18r
T6hbqPPeer2 ~~ T6hbqPPeer2
T8hbqPPeer2 ~~ T8hbqPPeer2
T10hbqh14br ~~ T10hbqh14br

###Item 3
T1hbq19r ~~ T1hbq19r
T3hbq19r ~~ T3hbq19r
T5hbq19r ~~ T5hbq19r
T6hbqPPeer3 ~~ T6hbqPPeer3
T8hbqPPeer3 ~~ T8hbqPPeer3
T10hbqh14cr ~~ T10hbqh14cr

###Item 4
T1hbq21r ~~ T1hbq21r
T3hbq21r ~~ T3hbq21r
T5hbq21r ~~ T5hbq21r
T6hbqPPeer4 ~~ T6hbqPPeer4
T8hbqPPeer4 ~~ T8hbqPPeer4
T10hbqh14dr ~~ T10hbqh14dr

###Item 5
T1hbq22r ~~ T1hbq22r
T3hbq22r ~~ T3hbq22r
T5hbq22r ~~ T5hbq22r
T6hbqPPeer5 ~~ T6hbqPPeer5
T8hbqPPeer5 ~~ T8hbqPPeer5
T10hbqh14er ~~ T10hbqh14er

###Item 6
T1hbq23r ~~ T1hbq23r
T3hbq23r ~~ T3hbq23r
T5hbq23r ~~ T5hbq23r
T6hbqPPeer6 ~~ T6hbqPPeer6
T8hbqPPeer6 ~~ T8hbqPPeer6
T10hbqh14fr ~~ T10hbqh14fr

###Item 7
T1hbq24 ~~ T1hbq24
T3hbq24 ~~ T3hbq24
T5hbq24 ~~ T5hbq24
T6hbqPPeer7 ~~ T6hbqPPeer7
T8hbqPPeer7 ~~ T8hbqPPeer7
T10hbqh14g ~~ T10hbqh14g

###Item 8
T1hbq25r ~~ T1hbq25r
T3hbq26r ~~ T3hbq26r
T5hbq25r ~~ T5hbq25r
T6hbqPPeer8 ~~ T6hbqPPeer8
T8hbqPPeer8 ~~ T8hbqPPeer8
T10hbqh14hr ~~ T10hbqh14hr

###Item 9
T1hbq26r ~~ T1hbq26r
T3hbq25r ~~ T3hbq25r
T5hbq26r ~~ T5hbq26r
T6hbqPPeer9 ~~ T6hbqPPeer9
T8hbqPPeer9 ~~ T8hbqPPeer9
T10hbqh14ir ~~ T10hbqh14ir

###Item 10
T1hbq28r ~~ T1hbq28r
T3hbq28r ~~ T3hbq28r
T5hbq28r ~~ T5hbq28r
T6hbqPPeer10 ~~ T6hbqPPeer10
T8hbqPPeer10 ~~ T8hbqPPeer10
T10hbqh14jr ~~ T10hbqh14jr

###Item 11
T1hbq29r ~~ T1hbq29r
T3hbq29r ~~ T3hbq29r
T5hbq29r ~~ T5hbq29r
T6hbqPPeer11 ~~ T6hbqPPeer11
T8hbqPPeer11 ~~ T8hbqPPeer11
T10hbqh14kr ~~ T10hbqh14kr

MDDCORE_1 ~~ MDDCORE_1          # This estimates the MDDCORE residual variances
MDDCORE_3 ~~ MDDCORE_3
MDDCORE_5 ~~ MDDCORE_5
MDDCORE_10 ~~ MDDCORE_10
MDDCORE_12 ~~ MDDCORE_12
MDDCORE_14 ~~ MDDCORE_14

#Dynamics

#Estimate the self-feedback parameters
dPeer_1~F1*Peer_1       # This estimates the Peer self-feedback parameter
dPeer_2~F1*Peer_2
dPeer_3~F1*Peer_3
dPeer_4~F1*Peer_4
dPeer_5~F1*Peer_5

dMDD_1~F2*MDD_1       # This estimates the MDD self-feedback parameter
dMDD_2~F2*MDD_2
dMDD_3~F2*MDD_3
dMDD_4~F2*MDD_4
dMDD_5~F2*MDD_5

#Estimate coupling parameter
dMDD_1~0*Peer_1         # This estimates the Peer to MDD coupling parameter
dMDD_2~0*Peer_2
dMDD_3~0*Peer_3
dMDD_4~0*Peer_4
dMDD_5~0*Peer_5

dPeer_1~C2*MDD_1         # This estimates the MDD to Peer coupling parameter
dPeer_2~C2*MDD_2
dPeer_3~C2*MDD_3
dPeer_4~C2*MDD_4
dPeer_5~C2*MDD_5

iPeer=~1*Peer_1                   # This defines the Peer intercept measurement model
sPeer=~1*dPeer_1+ 1*dPeer_2+ 1*dPeer_3+ 1*dPeer_4+ 1*dPeer_5 # This defines the Peer slope measurement model
iPeer~1                             # This estimates the Peer intercept intercept (mean)
iPeer~~iPeer                         # This estimates the Peer intercept variance
sPeer~1                             # This estimates the Peer slope intercept
sPeer~~sPeer                         # This estimates the Peer slope variance

iMDD=~1*MDD_1                   # This defines the MDD intercept measurement model
sMDD=~1*dMDD_1+ 1*dMDD_2+ 1*dMDD_3+ 1*dMDD_4+ 1*dMDD_5 # This defines the MDD slope measurement model
iMDD~1                             # This estimates the MDD intercept intercept (mean)
iMDD~~iMDD                         # This estimates the MDD intercept variance
sMDD~1                             # This estimates the MDD slope intercept
sMDD~~sMDD                         # This estimates the MDD slope variance

iMDD~~sMDD                      # This estimates the iMDD sMDD covariance
iMDD~~sPeer                      # This estimates the iMDD sPeer covariance
iMDD~~iPeer                      # This estimates the iMDD iPeer covariance
iPeer~~sPeer                      # This estimates the iPeer sPeer covariance
iPeer~~sMDD                      # This estimates the iPeer sMDD covariance
sPeer~~sMDD                      # This estimates the sPeer sMDD covariance
'

fit_PPeer_BMWLC_IS <- lavaan(PPeer_BMWLC_IS, data=data_wide, missing="FIML")
inspect(fit_PPeer_BMWLC_IS,"cor.lv")

summary(fit_PPeer_BMWLC_IS, fit.measures=T, standardized=T)

semPaths(fit_PPeer_BMWLC_IS, 'std', 'est', curveAdjacent=T, layout="tree", orthogonal=T, rescale=T,
         label.cex=T, label.scale=T, normalize=F, sizeMan=3, sizeInt=1, sizeLat=3, intercepts=F)

IS_fit <- fitMeasures(fit_PPeer_BMWLC_IS, c("chisq","df","rmsea"))
IS_fit[1]/(IS_fit[2]*(IR_fit[3]-IS_fit[3]))
```


Bivariate multiwave latent change model for Peer score for Transactional model
```{r Bivariate multiwave latent change model for Peer score for Transactional model}
PPeer_BMWLC_T <- '
#Defining the latent variables

Peer_1 =~ 1*T1hbq17+1*T1hbq18r+1*T1hbq19r+1*T1hbq21r+1*T1hbq22r+1*T1hbq23r+1*T1hbq24+1*T1hbq25r+1*T1hbq26r+1*T1hbq28r+1*T1hbq29r
Peer_2 =~ 1*T3hbq17+1*T3hbq18r+1*T3hbq19r+1*T3hbq21r+1*T3hbq22r+1*T3hbq23r+1*T3hbq24+1*T3hbq26r+1*T3hbq25r+1*T3hbq28r+1*T3hbq29r
Peer_3 =~ 1*T5hbq17+1*T5hbq18r+1*T5hbq19r+1*T5hbq21r+1*T5hbq22r+1*T5hbq23r+1*T5hbq24+1*T5hbq25r+1*T5hbq26r+1*T5hbq28r+1*T5hbq29r
Peer_4 =~ 1*T6hbqPPeer1+1*T6hbqPPeer2+1*T6hbqPPeer3+1*T6hbqPPeer4+1*T6hbqPPeer5+1*T6hbqPPeer6+1*T6hbqPPeer7+1*T6hbqPPeer8+1*T6hbqPPeer9+1*T6hbqPPeer10+1*T6hbqPPeer11
Peer_5 =~ 1*T8hbqPPeer1+1*T8hbqPPeer2+1*T8hbqPPeer3+1*T8hbqPPeer4+1*T8hbqPPeer5+1*T8hbqPPeer6+1*T8hbqPPeer7+1*T8hbqPPeer8+1*T8hbqPPeer9+1*T8hbqPPeer10+1*T8hbqPPeer11
Peer_6 =~ 1*T10hbqh14a+1*T10hbqh14br+1*T10hbqh14cr+1*T10hbqh14dr+1*T10hbqh14er+1*T10hbqh14fr+1*T10hbqh14g+1*T10hbqh14hr+1*T10hbqh14ir+1*T10hbqh14jr+1*T10hbqh14kr

MDD_1 =~ 1*MDDCORE_1
MDD_2 =~ 1*MDDCORE_3
MDD_3 =~ 1*MDDCORE_5
MDD_4 =~ 1*MDDCORE_10
MDD_5 =~ 1*MDDCORE_12
MDD_6 =~ 1*MDDCORE_14

#Define regressions
Peer_2 ~ 1*Peer_1
Peer_3 ~ 1*Peer_2
Peer_4 ~ 1*Peer_3
Peer_5 ~ 1*Peer_4
Peer_6 ~ 1*Peer_5

MDD_2 ~ 1*MDD_1
MDD_3 ~ 1*MDD_2
MDD_4 ~ 1*MDD_3
MDD_5 ~ 1*MDD_4
MDD_6 ~ 1*MDD_5

#Define the change score
dPeer_1 =~ 1*Peer_2        # This defines the change score as measured perfectly by scores on PPeer2
dPeer_2 =~ 1*Peer_3
dPeer_3 =~ 1*Peer_4
dPeer_4 =~ 1*Peer_5
dPeer_5 =~ 1*Peer_6
         
dMDD_1 =~ 1*MDD_2           # This defines the change score as measured perfectly by scores on MDDCORE_2
dMDD_2 =~ 1*MDD_3           
dMDD_3 =~ 1*MDD_4
dMDD_4 =~ 1*MDD_5
dMDD_5 =~ 1*MDD_6

#Estimate residual variances
##Parent-report
###Item 1
T1hbq17 ~~ T1hbq17
T3hbq17 ~~ T3hbq17
T5hbq17 ~~ T5hbq17
T6hbqPPeer1 ~~ T6hbqPPeer1
T8hbqPPeer1 ~~ T8hbqPPeer1
T10hbqh14a ~~ T10hbqh14a

###Item 2
T1hbq18r ~~ T1hbq18r
T3hbq18r ~~ T3hbq18r
T5hbq18r ~~ T5hbq18r
T6hbqPPeer2 ~~ T6hbqPPeer2
T8hbqPPeer2 ~~ T8hbqPPeer2
T10hbqh14br ~~ T10hbqh14br

###Item 3
T1hbq19r ~~ T1hbq19r
T3hbq19r ~~ T3hbq19r
T5hbq19r ~~ T5hbq19r
T6hbqPPeer3 ~~ T6hbqPPeer3
T8hbqPPeer3 ~~ T8hbqPPeer3
T10hbqh14cr ~~ T10hbqh14cr

###Item 4
T1hbq21r ~~ T1hbq21r
T3hbq21r ~~ T3hbq21r
T5hbq21r ~~ T5hbq21r
T6hbqPPeer4 ~~ T6hbqPPeer4
T8hbqPPeer4 ~~ T8hbqPPeer4
T10hbqh14dr ~~ T10hbqh14dr

###Item 5
T1hbq22r ~~ T1hbq22r
T3hbq22r ~~ T3hbq22r
T5hbq22r ~~ T5hbq22r
T6hbqPPeer5 ~~ T6hbqPPeer5
T8hbqPPeer5 ~~ T8hbqPPeer5
T10hbqh14er ~~ T10hbqh14er

###Item 6
T1hbq23r ~~ T1hbq23r
T3hbq23r ~~ T3hbq23r
T5hbq23r ~~ T5hbq23r
T6hbqPPeer6 ~~ T6hbqPPeer6
T8hbqPPeer6 ~~ T8hbqPPeer6
T10hbqh14fr ~~ T10hbqh14fr

###Item 7
T1hbq24 ~~ T1hbq24
T3hbq24 ~~ T3hbq24
T5hbq24 ~~ T5hbq24
T6hbqPPeer7 ~~ T6hbqPPeer7
T8hbqPPeer7 ~~ T8hbqPPeer7
T10hbqh14g ~~ T10hbqh14g

###Item 8
T1hbq25r ~~ T1hbq25r
T3hbq26r ~~ T3hbq26r
T5hbq25r ~~ T5hbq25r
T6hbqPPeer8 ~~ T6hbqPPeer8
T8hbqPPeer8 ~~ T8hbqPPeer8
T10hbqh14hr ~~ T10hbqh14hr

###Item 9
T1hbq26r ~~ T1hbq26r
T3hbq25r ~~ T3hbq25r
T5hbq26r ~~ T5hbq26r
T6hbqPPeer9 ~~ T6hbqPPeer9
T8hbqPPeer9 ~~ T8hbqPPeer9
T10hbqh14ir ~~ T10hbqh14ir

###Item 10
T1hbq28r ~~ T1hbq28r
T3hbq28r ~~ T3hbq28r
T5hbq28r ~~ T5hbq28r
T6hbqPPeer10 ~~ T6hbqPPeer10
T8hbqPPeer10 ~~ T8hbqPPeer10
T10hbqh14jr ~~ T10hbqh14jr

###Item 11
T1hbq29r ~~ T1hbq29r
T3hbq29r ~~ T3hbq29r
T5hbq29r ~~ T5hbq29r
T6hbqPPeer11 ~~ T6hbqPPeer11
T8hbqPPeer11 ~~ T8hbqPPeer11
T10hbqh14kr ~~ T10hbqh14kr

MDDCORE_1 ~~ MDDCORE_1          # This estimates the MDDCORE residual variances
MDDCORE_3 ~~ MDDCORE_3
MDDCORE_5 ~~ MDDCORE_5
MDDCORE_10 ~~ MDDCORE_10
MDDCORE_12 ~~ MDDCORE_12
MDDCORE_14 ~~ MDDCORE_14

#Dynamics

#Estimate the self-feedback parameters
dPeer_1~F1*Peer_1       # This estimates the Peer self-feedback parameter
dPeer_2~F1*Peer_2
dPeer_3~F1*Peer_3
dPeer_4~F1*Peer_4
dPeer_5~F1*Peer_5

dMDD_1~F2*MDD_1       # This estimates the MDD self-feedback parameter
dMDD_2~F2*MDD_2
dMDD_3~F2*MDD_3
dMDD_4~F2*MDD_4
dMDD_5~F2*MDD_5

#Estimate coupling parameter
dMDD_1~C1*Peer_1         # This estimates the Peer to MDD coupling parameter
dMDD_2~C1*Peer_2
dMDD_3~C1*Peer_3
dMDD_4~C1*Peer_4
dMDD_5~C1*Peer_5

dPeer_1~C2*MDD_1         # This estimates the MDD to Peer coupling parameter
dPeer_2~C2*MDD_2
dPeer_3~C2*MDD_3
dPeer_4~C2*MDD_4
dPeer_5~C2*MDD_5

iPeer=~1*Peer_1                   # This defines the Peer intercept measurement model
sPeer=~1*dPeer_1+ 1*dPeer_2+ 1*dPeer_3+ 1*dPeer_4+ 1*dPeer_5 # This defines the Peer slope measurement model
iPeer~1                             # This estimates the Peer intercept intercept (mean)
iPeer~~iPeer                         # This estimates the Peer intercept variance
sPeer~1                             # This estimates the Peer slope intercept
sPeer~~sPeer                         # This estimates the Peer slope variance

iMDD=~1*MDD_1                   # This defines the MDD intercept measurement model
sMDD=~1*dMDD_1+ 1*dMDD_2+ 1*dMDD_3+ 1*dMDD_4+ 1*dMDD_5 # This defines the MDD slope measurement model
iMDD~1                             # This estimates the MDD intercept intercept (mean)
iMDD~~iMDD                         # This estimates the MDD intercept variance
sMDD~1                             # This estimates the MDD slope intercept
sMDD~~sMDD                         # This estimates the MDD slope variance

iMDD~~sMDD                      # This estimates the iMDD sMDD covariance
iMDD~~sPeer                      # This estimates the iMDD sPeer covariance
iMDD~~iPeer                      # This estimates the iMDD iPeer covariance
iPeer~~sPeer                      # This estimates the iPeer sPeer covariance
iPeer~~sMDD                      # This estimates the iPeer sMDD covariance
sPeer~~sMDD                      # This estimates the sPeer sMDD covariance
'

fit_PPeer_BMWLC_T <- lavaan(PPeer_BMWLC_T, data=data_wide, missing="FIML",
                            control=list(eval.max=40000, iter.min=10000))
inspect(fit_PPeer_BMWLC_T,"cor.lv")

summary(fit_PPeer_BMWLC_T, fit.measures=T, standardized=T)

semPaths(fit_PPeer_BMWLC_T, 'std', 'est', curveAdjacent=T, layout="tree", orthogonal=T, rescale=T,
         label.cex=T, label.scale=T, normalize=F, sizeMan=3, sizeInt=1, sizeLat=3, intercepts=F)
```


# Correlated change (Steyer) 
Adapted from Leah Schultz's script
```{r Correlated change (Steyer)}
Peer_MWLC_2 <-'
#Defining the latent variables
Peer_1=~1*PPeer1+1*TPeer1        # Defining the Peer latent variables
Peer_2=~1*PPeer3+1*TPeer3        # Defining the Peer latent variables
Peer_3=~1*PPeer5+1*TPeer5        # Defining the Peer latent variables
Peer_4=~1*PPeer10+1*TPeer10        # Defining the Peer latent variables
Peer_5=~1*PPeer12+1*TPeer12        # Defining the Peer latent variables
Peer_6=~1*PPeer14+1*TPeer14        # Defining the Peer latent variables

MDD_1=~1*MDDCORE_1        # Defining the MDD latent variables
MDD_2=~1*MDDCORE_3        # Defining the MDD latent variables
MDD_3=~1*MDDCORE_5        # Defining the MDD latent variables
MDD_4=~1*MDDCORE_10        # Defining the MDD latent variables
MDD_5=~1*MDDCORE_12        # Defining the MDD latent variables
MDD_6=~1*MDDCORE_14        # Defining the MDD latent variables

#Not sure what this is doing!
PPeer1 ~ 0*1
TPeer1 ~ (pu1)*1
PPeer3 ~ 0*1
TPeer3 ~ (pu1)*1
PPeer5 ~ 0*1
TPeer5 ~ (pu1)*1
PPeer10 ~ 0*1
TPeer10 ~ (pu1)*1
PPeer12 ~ 0*1
TPeer12 ~ (pu1)*1
PPeer14 ~ 0*1
TPeer14 ~ (pu1)*1

MDDCORE_1 ~ 0*1
MDDCORE_3 ~ 0*1
MDDCORE_5 ~ 0*1
MDDCORE_10 ~ 0*1
MDDCORE_12 ~ 0*1
MDDCORE_14 ~ 0*1

#Estimate residual variances
PPeer1~~PPeer1          # This estimates the PPeer residual variances
PPeer3~~PPeer3
PPeer5~~PPeer5
PPeer10~~PPeer10
PPeer12~~PPeer12
PPeer14~~PPeer14

TPeer1~~TPeer1          # This estimates the TPeer residual variances
TPeer3~~TPeer3
TPeer5~~TPeer5
TPeer10~~TPeer10
TPeer12~~TPeer12
TPeer14~~TPeer14

MDDCORE_1~~MDDCORE_1          # This estimates the MDDCORE residual variances
MDDCORE_3~~MDDCORE_3
MDDCORE_5~~MDDCORE_5
MDDCORE_10~~MDDCORE_10
MDDCORE_12~~MDDCORE_12
MDDCORE_14~~MDDCORE_14

Peer_1 ~ 0*1
Peer_2 ~ 0*1
Peer_3 ~ 0*1
Peer_4 ~ 0*1
Peer_5 ~ 0*1
Peer_6 ~ 0*1

Peer_1 ~~ 0*Peer_1
Peer_2 ~~ 0*Peer_2
Peer_3 ~~ 0*Peer_3
Peer_4 ~~ 0*Peer_4
Peer_5 ~~ 0*Peer_5
Peer_6 ~~ 0*Peer_6

MDD_1 ~ 0*1
MDD_2 ~ 0*1
MDD_3 ~ 0*1
MDD_4 ~ 0*1
MDD_5 ~ 0*1
MDD_6 ~ 0*1

MDD_1 ~~ 0*MDD_1
MDD_2 ~~ 0*MDD_2
MDD_3 ~~ 0*MDD_3
MDD_4 ~~ 0*MDD_4
MDD_5 ~~ 0*MDD_5
MDD_6 ~~ 0*MDD_6

t1Peer =~ 1*Peer_1+ 1*Peer_2+ 1*Peer_3+ 1*Peer_4+ 1*Peer_5
t1Peer ~~ t1Peer
t1Peer ~ 1

d2Peer =~ 1*Peer_2+ 1*Peer_3+ 1*Peer_4+ 1*Peer_5
d2Peer ~~ d2Peer
d2Peer ~ 1

d3Peer =~ 1*Peer_3+ 1*Peer_4+ 1*Peer_5
d3Peer ~~ d3Peer
d3Peer ~ 1

d4Peer =~ 1*Peer_4+ 1*Peer_5
d4Peer ~~ d4Peer
d4Peer ~ 1

d5Peer =~ 1*Peer_5
d5Peer ~~ d5Peer
d5Peer ~ 1

t1Peer ~~ d2Peer + d3Peer + d4Peer + d5Peer
d2Peer ~~ d3Peer + d4Peer + d5Peer
d3Peer ~~ d4Peer + d5Peer
d4Peer ~~ d5Peer

t1MDD =~ 1*MDD_1+ 1*MDD_2+ 1*MDD_3+ 1*MDD_4+ 1*MDD_5
t1MDD ~~ t1MDD
t1MDD ~ 1

d2MDD =~ 1*MDD_2+ 1*MDD_3+ 1*MDD_4+ 1*MDD_5
d2MDD ~~ d2MDD
d2MDD ~ 1

d3MDD =~ 1*MDD_3+ 1*MDD_4+ 1*MDD_5
d3MDD ~~ d3MDD
d3MDD ~ 1

d4MDD =~ 1*MDD_4+ 1*MDD_5
d4MDD ~~ d4MDD
d4MDD ~ 1

d5MDD =~ 1*MDD_5
d5MDD ~~ d5MDD
d5MDD ~ 1

t1MDD ~~ d2MDD + d3MDD + d4MDD + d5MDD
d2MDD ~~ d3MDD + d4MDD + d5MDD
d3MDD ~~ d4MDD + d5MDD
d4MDD ~~ d5MDD

d2Peer ~~ 0*d3MDD + 0*d4MDD + 0*d5MDD
d3Peer ~~ 0*d5MDD
'

fit_Peer_MWLC_2 <- sem(Peer_MWLC_2, missing="ML", data = data_wide)

#Peer_MWLC_2_est <-parameterEstimates(fitN_cor_diff)
#fitN_cor_diff_est<-fitN_cor_diff_est[c(194,199,202,206),]
#fitN_cor_cfi<-fitMeasures(fitN_cor_diff, "cfi")
#fitN_cor_cfi
summary(fit_Peer_MWLC_2)
semPaths(fit_Peer_MWLC_2, 'std', 'est', curveAdjacent=T, layout="tree", orthogonal=T, rescale=T,
         label.cex=T, label.scale=T, normalize=F, sizeMan=3, sizeInt=1, sizeLat=3, intercepts=F)
```